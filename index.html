<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ventusky – Next Tee</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;padding:24px;line-height:1.4}
    .muted{opacity:.7}
    code{background:#0001;padding:2px 4px;border-radius:4px}
  </style>
</head>
<body>
  <h1>Opening Ventusky…</h1>
  <p id="status" class="muted">Fetching next tee…</p>

  <script>
    (async () => {
      const DATA_URL = "https://gist.githubusercontent.com/OdysseyDFX/d442348046a1a5f66bf882fb8a7e2d51/raw/iggolf.json";
      const LAT = 51.72987, LON = -1.01528, ZOOM = 12, LAYER = "rain-1h";
      const pad2 = n => String(n).padStart(2,"0");

      function go(url, msg){
        if (msg) document.getElementById("status").textContent = msg;
        location.replace(url);
      }

      // Fallback: open current conditions if anything goes wrong
      const urlNow = `https://www.ventusky.com/?p=${LAT};${LON};${ZOOM}&l=${LAYER}`;

      try {
        // Timeout + no-store to avoid cache hangs
        const controller = new AbortController();
        const t = setTimeout(() => controller.abort(), 6000);

        const res = await fetch(DATA_URL + "?_=" + Date.now(), {
          signal: controller.signal,
          cache: "no-store",
          mode: "cors",
          redirect: "follow",
          headers: { "Accept": "application/json" }
        });
        clearTimeout(t);

        if (!res.ok) throw new Error("HTTP " + res.status);

        let data;
        try { data = await res.json(); } catch { throw new Error("Bad JSON"); }

        const iso = data?.nextTee?.whenISO;
        if (!iso) return go(urlNow, "No next tee found. Opening current weather…");

        const d = new Date(iso); // ISO is UTC
        const YYYY = d.getUTCFullYear();
        const MM   = pad2(d.getUTCMonth()+1);
        const DD   = pad2(d.getUTCDate());
        const HH   = pad2(d.getUTCHours());

        const q = new URLSearchParams({
          p: `${LAT};${LON};${ZOOM}`,
          l: LAYER,
          t: `${YYYY}${MM}${DD}/${HH}`,  // authoritative time (UTC)
          d: `${YYYY}-${MM}-${DD}`,      // UI date hint
          h: HH,                         // UI hour hint
          z: String(ZOOM),
          play: "0",
          _: Date.now().toString()
        });
        const url = `https://www.ventusky.com/?${q.toString()}`;

        document.getElementById("status").innerHTML =
          `Next tee (UTC): <code>${iso}</code><br>Redirecting…`;
        location.replace(url);
      } catch (e) {
        go(urlNow, "Couldn’t load latest tee time. Opening current weather…");
      }
    })();
  </script>
</body>
</html>
